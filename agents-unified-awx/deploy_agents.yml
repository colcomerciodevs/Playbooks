---
- name: Despliegue unificado de agentes (Trendmicro / Zabbix / Nessus)
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true

  pre_tasks:
    - name: Mostrar selección de instalación
      debug:
        msg:
          - "Instalar Trendmicro: {{ install_trendmicro | default('NO') }}"
          - "Instalar Zabbix:     {{ install_zabbix | default('NO') }}"
          - "Instalar Nessus:     {{ install_nessus | default('NO') }}"

    - name: Validar que al menos un agente fue seleccionado
      fail:
        msg: "No seleccionaste ningún agente. Marca al menos uno en la encuesta (Survey)."
      when:
        - (install_trendmicro | default('NO') | upper) != "YES"
        - (install_zabbix     | default('NO') | upper) != "YES"
        - (install_nessus     | default('NO') | upper) != "YES"

  roles:
    - role: trendmicro
      when: (install_trendmicro | default('NO') | upper) == "YES"

    - role: zabbix_agent2
      when: (install_zabbix | default('NO') | upper) == "YES"

    - role: nessus_agent
      when: (install_nessus | default('NO') | upper) == "YES"
