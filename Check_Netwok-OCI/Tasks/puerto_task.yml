# --- ValidaciÃ³n de apertura de puertos TCP en la red ---

# ğŸ” Linux: Validar puerto usando redirecciÃ³n con /dev/tcp y timeout
- name: ğŸ§ Validar puerto {{ puerto_objetivo }} en {{ ip_obj }} (Linux)
  ansible.builtin.shell: |
    timeout 2 bash -c "echo > /dev/tcp/{{ ip_obj }}/{{ puerto_objetivo }}"
  register: resultado_puerto_linux
  ignore_errors: yes
  changed_when: false
  when: ansible_os_family != 'Windows'

# ğŸ” Windows: Validar puerto con PowerShell y TcpClient
- name: ğŸªŸ Validar puerto {{ puerto_objetivo }} en {{ ip_obj }} (Windows)
  win_shell: |
    try {
      $tcp = New-Object System.Net.Sockets.TcpClient
      $tcp.Connect("{{ ip_obj }}", {{ puerto_objetivo }})
      if ($tcp.Connected) {
        $tcp.Close()
        "Abierto"
      } else {
        $tcp.Close()
        "Cerrado"
      }
    } catch {
      "Cerrado"
    }
  register: resultado_puerto_windows
  changed_when: false
  ignore_errors: yes
  when: ansible_os_family == 'Windows'

# ğŸ§  Consolidar resultado segÃºn sistema operativo
- name: ğŸ§  Consolidar resultado del puerto segÃºn SO
  set_fact:
    resultado_puerto: "{{ resultado_puerto_linux if ansible_os_family != 'Windows' else resultado_puerto_windows }}"

# âœ… Evaluar si el puerto estÃ¡ abierto o cerrado
- name: ğŸ“Š Evaluar resultado del puerto
  set_fact:
    estado_puerto: >-
      {% if ansible_os_family == 'Windows' %}
        {{ 'Abierto' if resultado_puerto.stdout is search('Abierto') else 'Cerrado' }}
      {% else %}
        {{ 'Abierto' if resultado_puerto.rc is defined and resultado_puerto.rc == 0 else 'Cerrado' }}
      {% endif %}

# ğŸ§¾ Construir lÃ­nea de salida CSV para el resultado del puerto
- name: ğŸ“„ Construir lÃ­nea CSV de puerto
  set_fact:
    linea_puerto: >-
      {{
        hostname_actual | trim ~ ',' ~
        ip_local | trim ~ ',' ~
        netmask | trim ~ ',' ~
        gateway | trim ~ ',' ~
        'puerto' ~ ',' ~
        ip_obj | trim ~ ',' ~
        puerto_objetivo | string | trim ~ ',' ~
        estado_puerto | trim
      }}

# ğŸ“¥ Escribir resultado en archivo CSV consolidado
- name: ğŸ’¾ Guardar lÃ­nea de puerto en CSV
  local_action:
    module: lineinfile
    path: "{{ ruta_csv_local }}"
    line: "{{ linea_puerto }}"
    create: yes
    insertafter: EOF
  delegate_to: localhost

# ğŸ—’ï¸ Agregar entrada al log acumulado del host
- name: ğŸ“ Agregar entrada al log por puerto
  set_fact:
    contenido_log_total: "{{ contenido_log_total }}\nğŸ”Œ PUERTO {{ puerto_objetivo }} en {{ ip_obj }} â†’ {{ estado_puerto }}"
