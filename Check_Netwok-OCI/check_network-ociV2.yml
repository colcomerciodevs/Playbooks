---
- name: ðŸ” AnÃ¡lisis de red optimizado (Linux y Windows)
  hosts: PS_OUT
  gather_facts: yes

  vars:
    #archivo_ips: "{{ playbook_dir }}/archivo_ips.txt"         # ðŸ“„ IPs OUT a validar
    #archivo_puertos: "{{ playbook_dir }}/archivo_puertos.txt" # ðŸ“„ Puertos OUT a validar
    #archivo_ips: "{{ playbook_dir }}/archivo_ips_out.txt"         # ðŸ“„ IPs OUT a validar
    #archivo_ips: "{{ playbook_dir }}/archivo_ips_out-2.txt"         # ðŸ“„ IPs OUT 2 a validar
    archivo_puertos: "{{ playbook_dir }}/archivo_puertos_out.txt" # ðŸ“„ Puertos OUT a validar
    #archivo_ips: "{{ playbook_dir }}/archivos_ips_in.txt"         # ðŸ“„ IPs IN a validar
    archivo_ips: "{{ playbook_dir }}/archivos_ips_in-2.txt"         # ðŸ“„ IPs IN 2 a validar
    #archivo_puertos: "{{ playbook_dir }}/archivo_puertos_in.txt" # ðŸ“„ Puertos IN a  validar
    ruta_script_linux: "~/valida_red.sh"                      # ðŸ“œ Script en host Linux
    ruta_script_windows: "C:\\temp\\valida_red.ps1"           # ðŸ“œ Script en host Windows
    salida_csv_linux: "~/salida_valida_red.csv"              # ðŸ“‚ Archivo generado en Linux remoto
    salida_csv_windows: "C:\\temp\\salida_valida_red.csv"     # ðŸ“‚ Archivo generado en Windows remoto

    # ðŸ“… Ruta temporal local donde se almacenan los CSVs traÃ­dos por fetch
    ruta_local_linux: "{{ playbook_dir }}/Salidas_Playbooks/tmp_linux_{{ inventory_hostname }}.csv"
    ruta_local_windows: "{{ playbook_dir }}/Salidas_Playbooks/tmp_windows_{{ inventory_hostname }}.csv"

  vars_files:
    - vault_windows.yml  # ðŸ” Vault con ansible_password

  ##########################################################################
  # PRE-TASKS
  ##########################################################################
  pre_tasks:

    # ðŸ•’ Definir timestamp global para reporte
    - name: ðŸ•’ Definir timestamp global
      run_once: true
      delegate_to: localhost
      set_fact:
        timestamp_global: "{{ lookup('pipe', 'date +%Y-%m-%d_%H%M%S') }}"

    # ðŸª¼ Agregar salto de lÃ­nea final a archivo_puertos.txt si falta
    - name: ðŸª¼ Asegurar salto de lÃ­nea final en archivo_puertos.txt
      delegate_to: localhost
      run_once: true
      lineinfile:
        path: "{{ archivo_puertos }}"
        line: ""
        insertafter: EOF
        create: no

    - name: ðŸª¼ Asegurar salto de lÃ­nea final en archivo_ips.txt
      delegate_to: localhost
      run_once: true
      lineinfile:
        path: "{{ archivo_ips }}"
        line: ""
        insertafter: EOF
        create: no

    # ðŸ”§ Limpiar caracteres de retorno de carro (Windows CRLF â†’ Unix LF)
    - name: ðŸ”§ Normalizar archivo_puertos.txt (remover '\r')
      delegate_to: localhost
      run_once: true
      shell: "sed -i 's/\\r//' {{ archivo_puertos }}"
      args:
        executable: /bin/bash

    - name: ðŸ”§ Normalizar archivo_ips.txt (remover '\r')
      delegate_to: localhost
      run_once: true
      shell: "sed -i 's/\\r//' {{ archivo_ips }}"
      args:
        executable: /bin/bash

  ##########################################################################
  # TAREAS PRINCIPALES
  ##########################################################################
  tasks:

    # ðŸ“ Copiar archivos a servidores Linux
    - name: ðŸ“ Copiar archivos a servidores Linux
      when: ansible_os_family != 'Windows'
      copy:
        src: "{{ item.src }}"
        dest: "~/{{ item.dest }}"
        mode: '0755'
        force: true
      loop:
        - { src: "{{ archivo_ips }}", dest: "archivo_ips.txt" }
        - { src: "{{ archivo_puertos }}", dest: "archivo_puertos.txt" }
        - { src: "{{ playbook_dir }}/scripts/valida_red.sh", dest: "valida_red.sh" }

    # ðŸ“ Copiar archivos a servidores Windows
    - name: ðŸ“ Copiar archivos a servidores Windows
      when: ansible_os_family == 'Windows'
      win_copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      loop:
        - { src: "{{ archivo_ips }}", dest: 'C:\\temp\\archivo_ips.txt' }
        - { src: "{{ archivo_puertos }}", dest: 'C:\\temp\\archivo_puertos.txt' }
        - { src: "{{ playbook_dir }}/scripts/valida_red.ps1", dest: 'C:\\temp\\valida_red.ps1' }


    # â–¶ï¸ Ejecutar script en Linux
    - name: â–¶ï¸ Ejecutar script Linux
      when: ansible_os_family != 'Windows'
      shell: "bash {{ ruta_script_linux }}"
      args:
        executable: /bin/bash

    # â–¶ï¸ Ejecutar script en Windows
    - name: â–¶ï¸ Ejecutar script Windows
      when: ansible_os_family == 'Windows'
      win_shell: powershell -ExecutionPolicy Bypass -File {{ ruta_script_windows }}

    # ðŸ“… Obtener CSV desde Linux
    - name: ðŸ“… Traer CSV desde host Linux
      when: ansible_os_family != 'Windows'
      fetch:
        src: "{{ salida_csv_linux }}"
        dest: "{{ ruta_local_linux }}"
        flat: yes

    # ðŸ“… Obtener CSV desde Windows
    - name: ðŸ“… Traer CSV desde host Windows
      when: ansible_os_family == 'Windows'
      fetch:
        src: "{{ salida_csv_windows }}"
        dest: "{{ ruta_local_windows }}"
        flat: yes

    # âŒ Limpiar CSV remoto Linux
    - name: âŒ Eliminar CSV remoto en host Linux
      when: ansible_os_family != 'Windows'
      file:
        path: "{{ salida_csv_linux }}"
        state: absent

    # âŒ Limpiar CSV remoto Windows
    - name: âŒ Eliminar CSV remoto en host Windows
      when: ansible_os_family == 'Windows'
      win_file:
        path: "{{ salida_csv_windows }}"
        state: absent

  ##########################################################################
  # POST-TASKS - ConsolidaciÃ³n y ordenamiento
  ##########################################################################
  post_tasks:

    # ðŸª¼ Eliminar lÃ­neas vacÃ­as iniciales
    - name: ðŸª¼ Eliminar lÃ­neas en blanco iniciales en archivos CSV
      run_once: true
      delegate_to: localhost
      shell: |
        for archivo in {{ playbook_dir }}/Salidas_Playbooks/tmp_*.csv; do
          sed -i '/./,$!d' "$archivo"
        done
      args:
        executable: /bin/bash

    # ðŸ”§ Unir archivos Linux
    - name: ðŸ”§ Combinar archivos Linux
      run_once: true
      delegate_to: localhost
      shell: |
        if ls {{ playbook_dir }}/Salidas_Playbooks/tmp_linux_*.csv >/dev/null 2>&1; then
          cat {{ playbook_dir }}/Salidas_Playbooks/tmp_linux_*.csv > {{ playbook_dir }}/Salidas_Playbooks/reporte_red_linux_{{ timestamp_global }}.csv
        fi
      args:
        executable: /bin/bash


    # ðŸ”§ Unir archivos Windows
    - name: ðŸ”§ Combinar archivos Windows
      run_once: true
      delegate_to: localhost
      shell: |
        if ls {{ playbook_dir }}/Salidas_Playbooks/tmp_windows_*.csv >/dev/null 2>&1; then
          cat {{ playbook_dir }}/Salidas_Playbooks/tmp_windows_*.csv > {{ playbook_dir }}/Salidas_Playbooks/reporte_red_windows_{{ timestamp_global }}.csv
        fi
      args:
        executable: /bin/bash


    # ðŸ”® Ordenar Linux por hostname
    - name: ðŸ”® Ordenar reporte Linux por hostname
      run_once: true
      delegate_to: localhost
      shell: |
        archivo="{{ playbook_dir }}/Salidas_Playbooks/reporte_red_linux_{{ timestamp_global }}.csv"
        if [ -f "$archivo" ]; then
          sort "$archivo" -o "$archivo"
        fi
      args:
        executable: /bin/bash


    # ðŸ”® Ordenar Windows por hostname
    - name: ðŸ”® Ordenar reporte Windows por hostname
      run_once: true
      delegate_to: localhost
      shell: |
        archivo="{{ playbook_dir }}/Salidas_Playbooks/reporte_red_windows_{{ timestamp_global }}.csv"
        if [ -f "$archivo" ]; then
          sort "$archivo" -o "$archivo"
        fi
      args:
        executable: /bin/bash
