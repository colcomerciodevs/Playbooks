---
# =============================================================================
# audit_zabbix.yml â€” Playbook independiente de auditorÃ­a (solo lectura)
#
# EjecuciÃ³n:
#   ansible-playbook -i inventario.ini audit_zabbix.yml
#   ansible-playbook -i inventario.ini audit_zabbix.yml -e "zbx_audit_out_json=Salidas_Playbooks/audit_custom.json"
#
# Estructura:
#   â€¢ PLAY 1 â†’ Ejecuta el rol zabbix_agent2 (solo tareas de auditorÃ­a)
#   â€¢ PLAY 2 â†’ Consolida resultados, genera JSON y ejecuta Python â†’ Excel
# =============================================================================

# ==== PLAY 1: Recolectar facts de auditorÃ­a por host ====
- name: 01) AuditorÃ­a Zabbix Agent1/Agent2 (recolecciÃ³n por host)
  hosts: all
  become: true
  gather_facts: true


  # âš ï¸ Importante: usamos include_role con tasks_from=audit.yml
  # para NO ejecutar el main.yml (instalaciÃ³n/desinstalaciÃ³n)
  tasks:
    - name: Ejecutar solo las tareas de auditorÃ­a del rol zabbix_agent2
      ansible.builtin.include_role:
        name: zabbix_agent2
        tasks_from: audit.yml


# ==== PLAY 2: Consolidar resultados y generar reporte final ====
- name: 02) Consolidar auditorÃ­a y generar reportes
  hosts: localhost
  gather_facts: false
  vars:
    zbx_audit_out_json: "Salidas_Playbooks/audit_zabbix_extended.json"
    zbx_audit_out_excel: "Salidas_Playbooks/Auditoria_Zabbix_Agentes.xlsx"

  tasks:

    # 12ï¸âƒ£ Consolidar todas las filas en el controlador
    - name: 12) Consolidar filas de auditorÃ­a desde los hostvars
      ansible.builtin.set_fact:
        all_rows: >-
          {{
            groups['all']
            | map('extract', hostvars, '_zbx_audit_row')
            | select('defined')
            | list
          }}

    # 12.1ï¸âƒ£ Validar que existan filas recolectadas
    - name: 12.1) Validar que existan filas recolectadas
      ansible.builtin.assert:
        that:
          - all_rows | length > 0
        fail_msg: "âŒ No se recolectaron filas de auditorÃ­a."
        success_msg: "âœ… Se recolectaron {{ all_rows | length }} filas."

    # 12.2ï¸âƒ£ Guardar JSON consolidado
    - name: 12.2) Guardar archivo JSON consolidado
      ansible.builtin.copy:
        dest: "{{ zbx_audit_out_json }}"
        mode: "0644"
        content: "{{ all_rows | to_nice_json }}"
      changed_when: false

    # 12.3ï¸âƒ£ Mostrar ruta del JSON generado
    - name: 12.3) Mostrar ruta del JSON generado
      ansible.builtin.debug:
        msg: "ğŸ“ Archivo JSON generado: {{ zbx_audit_out_json }}"

    # 13ï¸âƒ£ Ejecutar el script Python de exportaciÃ³n a Excel
    - name: 13) Ejecutar script export_audit_excel.py (convertir JSON â†’ Excel)
      ansible.builtin.command: >
        python3 scripts/export_audit_excel.py
        {{ zbx_audit_out_json }}
        {{ zbx_audit_out_excel }}
      register: export_excel
      changed_when: "'Exportado' in export_excel.stdout or 'âœ…' in export_excel.stdout"
      failed_when: export_excel.rc != 0

    # 14ï¸âƒ£ Mostrar resultado final del proceso completo
    - name: 14) Mostrar resumen final de la auditorÃ­a
      ansible.builtin.debug:
        msg:
          - "âœ… AuditorÃ­a completada correctamente"
          - "ğŸ“„ JSON: {{ zbx_audit_out_json }}"
          - "ğŸ“Š Excel: {{ zbx_audit_out_excel }}"
