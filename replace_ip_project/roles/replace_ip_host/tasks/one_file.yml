---
# ---------------------------------------------------------
# (A) BEFORE: Buscar IP exacta (con número de línea)
# ---------------------------------------------------------
- name: BEFORE - Buscar IP exacta en {{ f.path }}
  ansible.builtin.shell: "grep -nE '{{ _old_ip_regex }}' '{{ f.path }}' || true"
  register: _before
  changed_when: false

# ---------------------------------------------------------
# (B) Flag: ¿hubo coincidencias?
# (ansible-lint: usar length en vez de != "")
# ---------------------------------------------------------
- name: Definir si hay coincidencias en {{ f.path }}
  ansible.builtin.set_fact:
    _has_match: "{{ (_before.stdout | default('')) | length > 0 }}"

# ---------------------------------------------------------
# (C) REPLACE: Reemplazar SOLO si hubo coincidencias
# ---------------------------------------------------------
- name: Reemplazar IP exacta por hostname
  ansible.builtin.replace:
    path: "{{ f.path }}"
    regexp: "{{ _old_ip_regex }}"
    replace: "{{ new_host }}"
  register: _replace
  when: _has_match

# ---------------------------------------------------------
# (D) AFTER: Validar que NO quede la IP
# ---------------------------------------------------------
- name: AFTER - Validar que NO quede la IP
  ansible.builtin.shell: "grep -nE '{{ _old_ip_regex }}' '{{ f.path }}' || true"
  register: _after_ip
  changed_when: false
  when: _has_match

# ---------------------------------------------------------
# (E) AFTER: Capturar líneas con hostname (evidencia)
# ---------------------------------------------------------
- name: AFTER - Mostrar líneas con hostname
  ansible.builtin.shell: "grep -n '{{ new_host }}' '{{ f.path }}' || true"
  register: _after_host
  changed_when: false
  when:
    - _has_match
    - capture_after_host_lines | bool

# ---------------------------------------------------------
# (F) Registrar resultado
# ---------------------------------------------------------
- name: Registrar resultado del archivo
  ansible.builtin.set_fact:
    replace_ip_results: "{{ replace_ip_results + [ _result_item ] }}"
  vars:
    _status: >-
      {{
        'SKIPPED' if not _has_match else
        ('OK' if
          (((_after_ip.stdout | default('')) | length) == 0) and
          (
            (not (capture_after_host_lines | bool)) or
            (((_after_host.stdout | default('')) | length) > 0)
          )
         else 'FAIL')
      }}
    _result_item:
      file: "{{ f.path }}"
      before_lines: "{{ _before.stdout_lines | default([]) }}"
      after_ip_lines: "{{ _after_ip.stdout_lines | default([]) if _has_match else [] }}"
      after_host_lines: "{{ _after_host.stdout_lines | default([]) if (_has_match and (capture_after_host_lines | bool)) else [] }}"
      changed: "{{ _replace.changed | default(false) }}"
      status: "{{ _status }}"
