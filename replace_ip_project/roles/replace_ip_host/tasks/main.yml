---
# ----------------------------------------------------------
# (0) Construye regex exacto si no se suministra old_ip_regex
# - Usa bordes \\b + regex_escape para coincidir SOLO la IP literal
# ----------------------------------------------------------
- name: Construir regex exacta para la IP (si no viene definida)
  ansible.builtin.set_fact:
    _old_ip_regex: >-
      {{
        old_ip_regex | default('') | length > 0
        | ternary(old_ip_regex,
          '\\b' ~ (old_ip | regex_escape) ~ '\\b'
        )
      }}

# ------------------------------------------
# (1) Encuentra scripts seg√∫n file_patterns
# ------------------------------------------
- name: Buscar scripts en {{ scan_root }}
  ansible.builtin.find:
    paths: "{{ scan_root }}"
    patterns: "{{ file_patterns }}"
    file_type: file
    recurse: true
  register: _found_scripts

# ------------------------------------------------
# (2) Inicializa el array de resultados por host
# ------------------------------------------------
- name: Inicializar resultados del rol (por host)
  ansible.builtin.set_fact:
    replace_ip_results: []

# ---------------------------------------------------------
# (3) Procesa cada archivo encontrado (pre-scan, replace, post-scan)
# ---------------------------------------------------------
- name: Procesar cada archivo encontrado
  ansible.builtin.include_tasks: one_file.yml
  loop: "{{ _found_scripts.files }}"
  loop_control:
    loop_var: f

# ---------------------------------------------------------
# (4) Genera un summary final por host (totales + detalle)
# ---------------------------------------------------------
- name: Resumen del rol (por host)
  ansible.builtin.set_fact:
    replace_ip_summary:
      host: "{{ inventory_hostname }}"
      scan_root: "{{ scan_root }}"
      old_ip: "{{ old_ip }}"
      new_host: "{{ new_host }}"
      generated_at: "{{ ansible_date_time.iso8601 | default(lookup('pipe','date -Iseconds')) }}"
      totals:
        files_scanned: "{{ _found_scripts.matched | default(0) }}"
        files_with_ip_before: "{{ replace_ip_results | selectattr('before_lines','defined') | selectattr('before_lines','length') | list | length }}"
        ok: "{{ replace_ip_results | selectattr('status','equalto','OK') | list | length }}"
        fail: "{{ replace_ip_results | selectattr('status','equalto','FAIL') | list | length }}"
        skipped: "{{ replace_ip_results | selectattr('status','equalto','SKIPPED') | list | length }}"
      files: "{{ replace_ip_results }}"
