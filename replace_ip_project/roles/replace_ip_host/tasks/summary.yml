---
# Construir resumen por host con totales + detalle
- name: Construir resumen final del host
  ansible.builtin.set_fact:
    replace_ip_summary:
      host: "{{ inventory_hostname }}"
      scan_root: "{{ scan_root }}"
      old_ip: "{{ old_ip }}"
      new_host: "{{ new_host }}"
      generated_at: "{{ ansible_date_time.iso8601 }}"
      totals:
        files_scanned: "{{ (_found_scripts.matched | default(0)) | int }}"

        # Cantidad de archivos que tuvieron coincidencias antes (before_lines con contenido)
        files_with_ip_before: >-
          {{
            (replace_ip_results | default([]))
            | selectattr('before_lines', 'defined')
            | selectattr('before_lines', 'ne', [])
            | list
            | length
          }}

        ok: "{{ (replace_ip_results | default([]) | selectattr('status','equalto','OK') | list | length) | int }}"
        fail: "{{ (replace_ip_results | default([]) | selectattr('status','equalto','FAIL') | list | length) | int }}"
        skipped: "{{ (replace_ip_results | default([]) | selectattr('status','equalto','SKIPPED') | list | length) | int }}"
      files: "{{ replace_ip_results | default([]) }}"
