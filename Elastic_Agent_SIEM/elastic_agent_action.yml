---
- name: Elastic Agent | Acción selectiva + Reporte
  hosts: CRM04_K8S
  become: true
  gather_facts: true

  tasks:

    # =========================
    # (A) SOLO RE-ENROLL
    # =========================
    - name: "Elastic Agent | Re-enroll (tasks_from=enroll.yml)"
      ansible.builtin.include_role:
        name: elastic_agent_siem
        tasks_from: enroll.yml
      when: elastic_action | default('restart') == 'reenroll'

    - name: "Elastic Agent | Record mínimo (tasks_from=record_min.yml)"
      ansible.builtin.include_role:
        name: elastic_agent_siem
        tasks_from: record_min.yml
      when: elastic_action | default('restart') == 'reenroll'

    # =========================
    # (B) SOLO RESTART
    # =========================
    - name: "Elastic Agent | Restart/Status/Record (tasks_from=service.yml)"
      ansible.builtin.include_role:
        name: elastic_agent_siem
        tasks_from: service.yml
      when: elastic_action | default('restart') == 'restart'

    # =========================
    # (C) RE-ENROLL + RESTART (opcional)
    # =========================
    - name: "Elastic Agent | Re-enroll (reenroll_restart)"
      ansible.builtin.include_role:
        name: elastic_agent_siem
        tasks_from: enroll.yml
      when: elastic_action | default('restart') == 'reenroll_restart'

    # (Opcional) Si quieres dejar evidencia de reenroll aun si luego falla service.yml,
    # puedes armar record_min aquí y luego service.yml lo "completa".
    - name: "Elastic Agent | Record mínimo (reenroll_restart)"
      ansible.builtin.include_role:
        name: elastic_agent_siem
        tasks_from: record_min.yml
      when: elastic_action | default('restart') == 'reenroll_restart'

    - name: "Elastic Agent | Restart/Status/Record (reenroll_restart)"
      ansible.builtin.include_role:
        name: elastic_agent_siem
        tasks_from: service.yml
      when: elastic_action | default('restart') == 'reenroll_restart'

    # =========================
    # (D) SIEMPRE REPORTE
    # =========================
    - name: "Elastic Agent | Report JSON/Excel (tasks_from=report.yml)"
      ansible.builtin.include_role:
        name: elastic_agent_siem
        tasks_from: report.yml
