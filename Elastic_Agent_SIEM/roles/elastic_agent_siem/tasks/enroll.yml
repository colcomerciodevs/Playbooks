---

# (1) Validar si existe la unidad systemd del servicio
- name: "Elastic Agent | Verificar existencia de la unidad systemd"
  ansible.builtin.command: "systemctl list-unit-files {{ elastic_agent_service_name }} --no-pager --no-legend"
  register: elastic_unit_files
  changed_when: false
  failed_when: false

# (2) Bandera: existe servicio si list-unit-files devuelve algo
- name: "Elastic Agent | Definir service_exists"
  ansible.builtin.set_fact:
    elastic_service_exists: "{{ (elastic_unit_files.stdout | default('') | trim) != '' }}"
  changed_when: false

- name: Stop elastic-agent (before re-enroll)
  ansible.builtin.systemd:
    name: elastic-agent
    state: stopped
  become: true
  when: elastic_service_exists | bool

- name: Re-enroll elastic-agent (service already installed)
  ansible.builtin.command: >
    elastic-agent enroll
    --url={{ elastic_fleet_url }}
    --enrollment-token={{ elastic_enrollment_token }}
    {% if elastic_insecure | default(true) %} --insecure {% endif %}
  register: enroll_out
  changed_when: >
    (enroll_out.rc == 0) and
    (
      'Enrolled' in (enroll_out.stdout | default('')) or
      'Successfully' in (enroll_out.stdout | default('')) or
      'already' in (enroll_out.stdout | default(''))
    )
  failed_when: enroll_out.rc != 0
  become: true

- name: Start elastic-agent (after re-enroll)
  ansible.builtin.systemd:
    name: elastic-agent
    state: started
    enabled: true
  become: true
