---
# ==========================================================
# Elastic Agent | service.yml (Ansible 2.9 - SIMPLE y SEGURO)
# - Verifica existencia del servicio systemd
# - Reinicia si existe
# - Consulta is-active y status si existe
# - Ejecuta "elastic-agent version"
# - Parseo de versión con regex_findall (estable en 2.9)
# - Construye elastic_agent_record para el reporte
# ==========================================================

# (1) Validar si existe la unidad systemd del servicio
- name: "Elastic Agent | Verificar existencia de la unidad systemd"
  ansible.builtin.command: "systemctl list-unit-files {{ elastic_agent_service_name }} --no-pager --no-legend"
  register: elastic_unit_files
  changed_when: false
  failed_when: false

# (2) Bandera: existe servicio si list-unit-files devuelve algo
- name: "Elastic Agent | Definir service_exists"
  ansible.builtin.set_fact:
    elastic_service_exists: "{{ (elastic_unit_files.stdout | default('') | trim) != '' }}"
  changed_when: false

# (3) Reiniciar SOLO si existe (no fallar el play aunque falle restart)
- name: "Elastic Agent | Reiniciar servicio (solo si existe)"
  ansible.builtin.command: "systemctl restart {{ elastic_agent_service_name }}"
  register: elastic_restart_cmd
  changed_when: true
  failed_when: false
  when: elastic_service_exists | bool

# (4) Consultar is-active SOLO si existe
- name: "Elastic Agent | Consultar is-active (solo si existe)"
  ansible.builtin.command: "systemctl is-active {{ elastic_agent_service_name }}"
  register: elastic_is_active
  changed_when: false
  failed_when: false
  when: elastic_service_exists | bool

# (5) Consultar status detallado SOLO si existe
- name: "Elastic Agent | Consultar status detallado (solo si existe)"
  ansible.builtin.command: "systemctl status {{ elastic_agent_service_name }} --no-pager -l"
  register: elastic_status
  changed_when: false
  failed_when: false
  when: elastic_service_exists | bool

# ==========================================================
# (VERSIÓN) Ejecutar elastic-agent version y parsear
# ==========================================================

# (6) Ejecutar elastic-agent version (no fallar si no existe)
- name: "Elastic Agent | Obtener versión (elastic-agent version)"
  ansible.builtin.shell: |
    set -o pipefail
    elastic-agent version
  args:
    executable: /bin/bash
  register: elastic_version_cmd
  changed_when: false
  failed_when: false

# (7) Unir stdout+stderr (string único para parseo)
- name: "Elastic Agent | Unificar salida de versión"
  ansible.builtin.set_fact:
    elastic_version_raw: "{{ (elastic_version_cmd.stdout | default('')) ~ ' ' ~ (elastic_version_cmd.stderr | default('')) }}"
  changed_when: false

# (8) Obtener lista de versiones encontradas (Ansible 2.9 friendly)
- name: "Elastic Agent | Obtener lista de versiones encontradas"
  ansible.builtin.set_fact:
    elastic_version_matches: "{{ elastic_version_raw | regex_findall('[0-9]+\\.[0-9]+\\.[0-9]+') }}"
  changed_when: false

# (9) Tomar la primera versión (si lista vacía => NO INSTALADO)
- name: "Elastic Agent | Definir versión final"
  ansible.builtin.set_fact:
    elastic_version: "{{ (elastic_version_matches | first) | default('NO INSTALADO', true) }}"
  changed_when: false

# (10) DEBUG para validar (RAW/MATCHES/PARSED)
- name: "DEBUG | Elastic Agent versión (RAW/MATCHES/PARSED)"
  ansible.builtin.debug:
    msg:
      - "HOST={{ inventory_hostname }}"
      - "RC={{ elastic_version_cmd.rc | default('N/A') }}"
      - "STDOUT={{ elastic_version_cmd.stdout | default('') }}"
      - "STDERR={{ elastic_version_cmd.stderr | default('') }}"
      - "RAW={{ elastic_version_raw }}"
      - "MATCHES={{ elastic_version_matches | default([]) }}"
      - "PARSED={{ elastic_version }}"
  changed_when: false

# ==========================================================
# (REGISTRO) Construir datos por host para el reporte
# ==========================================================

# (11) Construir registro final por host
- name: "Elastic Agent | Construir registro por host para reporte"
  ansible.builtin.set_fact:
    elastic_agent_record:
      # 1) Nombre en el inventario
      inventory_name: "{{ inventory_hostname }}"
      # 2) Hostname real del servidor
      hostname: "{{ ansible_hostname | default('N/A') }}"
      # 3) IP del inventario (ansible_host)
      inventory_ip: "{{ ansible_host | default('N/A') }}"

      # 4) Versión Elastic Agent
      elastic_version: "{{ elastic_version }}"

      # 5) Reinicio OK (solo si existe unidad y restart rc=0)
      restart_ok: >-
        {{
          (elastic_service_exists | bool)
          and (elastic_restart_cmd is defined)
          and ((elastic_restart_cmd.rc | default(1)) == 0)
        }}

      # 6) Estado del servicio
      is_active: >-
        {{
          'NO EXISTE'
          if not (elastic_service_exists | bool)
          else (elastic_is_active.stdout | default('unknown'))
        }}

      # 7) OK (verde/rojo)
      ok: >-
        {{
          (elastic_service_exists | bool)
          and ((elastic_is_active.stdout | default('')) == 'active')
        }}

      # 8) Extracto de status
      status_excerpt: >-
        {{
          ('Unidad systemd no existe: ' ~ elastic_agent_service_name)
          if not (elastic_service_exists | bool)
          else ((elastic_status.stdout | default(''))[:elastic_agent_status_excerpt_len])
        }}
  changed_when: false
