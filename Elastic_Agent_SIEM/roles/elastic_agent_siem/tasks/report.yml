---
# ==========================================================
# Elastic Agent | report.yml
# - Crea carpeta local
# - Copia script Python de export
# - Asegura JSON
# - Lee JSON actual
# - Consolida hostvars[*].elastic_agent_record
# - Exporta Excel
# - Muestra rutas finales
# ==========================================================

# ----------------------------------------------------------
# (1) Asegurar carpeta local de salida (localhost)
# ----------------------------------------------------------
- name: "Elastic Agent | Asegurar carpeta local de salida"
  ansible.builtin.file:
    path: "{{ elastic_agent_report_dir }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true

# ----------------------------------------------------------
# (2) Copiar script de export Excel a localhost
# ----------------------------------------------------------
- name: "Elastic Agent | Copiar script de export Excel a localhost"
  ansible.builtin.copy:
    src: "export_excel_elastic_agent.py"
    dest: "{{ elastic_agent_report_dir }}/export_excel_elastic_agent.py"
    mode: "0755"
  delegate_to: localhost
  run_once: true

# ----------------------------------------------------------
# (3) Asegurar JSON existe (si no existe, crear [])
# ----------------------------------------------------------
- name: "Elastic Agent | Asegurar JSON existe (si no existe, crear [])"
  ansible.builtin.copy:
    dest: "{{ elastic_agent_report_json }}"
    content: "[]"
    force: false
    mode: "0644"
  delegate_to: localhost
  run_once: true

# ----------------------------------------------------------
# (4) Leer JSON existente
# ----------------------------------------------------------
- name: "Elastic Agent | Leer JSON existente"
  ansible.builtin.slurp:
    src: "{{ elastic_agent_report_json }}"
  delegate_to: localhost
  run_once: true
  register: elastic_existing_json

# ----------------------------------------------------------
# (5) Consolidar registros de todos los hosts en JSON
# ----------------------------------------------------------
- name: "Elastic Agent | Consolidar registros de todos los hosts en JSON"
  ansible.builtin.copy:
    dest: "{{ elastic_agent_report_json }}"
    content: >-
      {{
        (
          (elastic_existing_json.content | b64decode | from_json)
          +
          (hostvars
            | dict2items
            | map(attribute='value.elastic_agent_record')
            | select('defined')
            | list)
        ) | to_nice_json
      }}
    mode: "0644"
  delegate_to: localhost
  run_once: true

# ----------------------------------------------------------
# (6) Exportar Excel con Python (localhost)
# ----------------------------------------------------------
- name: "Elastic Agent | Exportar Excel con Python (localhost)"
  ansible.builtin.command: >
    python3 {{ elastic_agent_report_dir }}/export_excel_elastic_agent.py
    {{ elastic_agent_report_json }}
    {{ elastic_agent_report_xlsx }}
  delegate_to: localhost
  run_once: true
  register: elastic_excel_export
  changed_when: false
  failed_when: elastic_excel_export.rc != 0

# ----------------------------------------------------------
# (7) Mostrar rutas generadas
# ----------------------------------------------------------
- name: "Elastic Agent | Mostrar rutas generadas"
  ansible.builtin.debug:
    msg:
      - "JSON: {{ elastic_agent_report_json }}"
      - "XLSX: {{ elastic_agent_report_xlsx }}"
  delegate_to: localhost
  run_once: true
