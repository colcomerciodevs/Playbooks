---
# =========================================================
#  FASE 0 - DETECCIÓN BÁSICA Y ACCIONES (RESTART -> LINK)
# =========================================================

# 01# Obtener service_facts iniciales
- name: 01# Obtener service_facts iniciales
  ansible.builtin.service_facts:

# 02# Calcular unit de Nessus (si existe)
- name: 02# Calcular unit de Nessus (si existe)
  ansible.builtin.set_fact:
    nessus_unit: >-
      {{
        'nessusagent' if 'nessusagent.service' in ansible_facts.services
        else (
          'nessus-agent' if 'nessus-agent.service' in ansible_facts.services
          else ''
        )
      }}

# 03# Comprobar existencia de nessuscli
- name: 03# Comprobar existencia de nessuscli
  ansible.builtin.stat:
    path: "{{ nessus_cli_path }}"
  register: _nessuscli_stat

# DEBUG opcional para ver condiciones de reinicio
- name: DEBUG - Condiciones para reinicio
  ansible.builtin.debug:
    msg:
      nessus_unit: "{{ nessus_unit }}"
      restart_var: "{{ nessus_audit_restart_service }}"
      restart_var_bool: "{{ nessus_audit_restart_service | bool }}"
  when: ansible_verbosity | default(0) | int >= 1

# 04# Reiniciar Nessus Agent (opcional, PRIMERO)
- name: 04# Reiniciar Nessus Agent (opcional)
  ansible.builtin.systemd:
    name: "{{ nessus_unit }}"
    state: restarted
  when:
    - nessus_unit is defined
    - nessus_unit | trim != ''
    - nessus_audit_restart_service | bool
  register: _restart_res
  failed_when: false

# 05# Flag de reinicio durante auditoría
- name: 05# Marcar flag de reinicio durante auditoría
  ansible.builtin.set_fact:
    _restarted_during_audit: >-
      {{
        _restart_res is defined
        and (_restart_res is not skipped)
      }}
  when: nessus_unit | trim != ''

# 06# Ejecutar nessuscli agent status (tras el reinicio)
- name: 06# Ejecutar nessuscli agent status (post-reinicio)
  ansible.builtin.shell: "{{ nessus_cli_path }} agent status 2>&1"
  args:
    executable: /bin/bash
  register: _status_post_restart
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)
  environment:
    LC_ALL: C

# 07# Evaluar si el agente no está linkeado (Linked to: None) tras el reinicio
- name: 07# Evaluar si el agente no está linkeado (post-reinicio)
  ansible.builtin.set_fact:
    _pre_not_linked: >-
      {{
        _status_post_restart.stdout is defined
        and (_status_post_restart.stdout | default('')) is search('Linked to:\\s*None')
      }}
  when: _status_post_restart is defined

# 08# Linkear Nessus Agent (si no está linkeado) DESPUÉS del reinicio
- name: 08# Linkear Nessus Agent (si no está linkeado)
  ansible.builtin.command: >
    {{ nessus_cli_path }} agent link
    --key={{ nessus_agent_key }}
    --host={{ nessus_manager_host }}
    --port={{ nessus_manager_port }}
  register: _link_result
  when:
    - nessus_audit_try_link | bool
    - _nessuscli_stat.stat.exists | default(false)
    - _pre_not_linked | default(false)
    - nessus_agent_key | length > 0
    - nessus_manager_host | length > 0
  failed_when: false
  changed_when: "'Successfully linked' in (_link_result.stdout | default('')) or 'already linked' in (_link_result.stdout | default(''))"

# 09# Flag de link durante auditoría
- name: 09# Marcar flag de link durante auditoría
  ansible.builtin.set_fact:
    _linked_during_audit: >-
      {{
        _link_result is defined
        and (
          'Successfully linked' in (_link_result.stdout | default(''))
          or 'already linked' in (_link_result.stdout | default(''))
        )
      }}
  when: _link_result is defined

# =========================================================
#  FASE 1 - RE-OBTENER ESTADO REAL DESPUÉS DE LINK/RESTART
# =========================================================

# 10# Refrescar service_facts después de las acciones
- name: 10# Refrescar service_facts (post-acciones)
  ansible.builtin.service_facts:

# 11# Recalcular unit de Nessus (posibles cambios)
- name: 11# Recalcular unit de Nessus (post-acciones)
  ansible.builtin.set_fact:
    nessus_unit: >-
      {{
        'nessusagent' if 'nessusagent.service' in ansible_facts.services
        else (
          'nessus-agent' if 'nessus-agent.service' in ansible_facts.services
          else ''
        )
      }}

# 12# Consultar systemctl is-active (estado final)
- name: 12# Consultar systemctl is-active (estado final)
  ansible.builtin.command: "systemctl is-active {{ nessus_unit }}"
  register: _svc_active_final
  changed_when: false
  failed_when: false
  when: nessus_unit | length > 0

# 13# Ejecutar nessuscli agent status (estado final)
- name: 13# Ejecutar nessuscli agent status (estado final)
  ansible.builtin.shell: "{{ nessus_cli_path }} agent status 2>&1"
  args:
    executable: /bin/bash
  register: _status_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)
  environment:
    LC_ALL: C

# 14# Extraer Link status (estado final)
- name: 14# Extraer Link status (estado final)
  ansible.builtin.shell: |
    set -o pipefail
    {{ nessus_cli_path }} agent status 2>&1 \
    | tr -d '\r' \
    | grep -i '^Link[[:space:]]\+status[[:space:]]*:' -m1 \
    | sed -E 's/^[Ll]ink[[:space:]]+status[[:space:]]*:[[:space:]]*//'
  args:
    executable: /bin/bash
  register: _ls_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 15# Extraer Linked to (estado final)
- name: 15# Extraer Linked to (estado final)
  ansible.builtin.shell: |
    set -o pipefail
    {{ nessus_cli_path }} agent status 2>&1 \
    | tr -d '\r' \
    | grep -i '^Linked[[:space:]]\+to[[:space:]]*:' -m1 \
    | sed -E 's/^[Ll]inked[[:space:]]+to[[:space:]]*:[[:space:]]*//'
  args:
    executable: /bin/bash
  register: _lt_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 16# Normalizar indicadores finales de link
- name: 16# Normalizar indicadores finales de link
  ansible.builtin.set_fact:
    _link_status_final: "{{ (_ls_cmd.stdout | default('') | trim) | default('N/A') }}"
    _linked_bool: >-
      {{
        (_lt_cmd.stdout | default('') | trim | length > 0)
        and ((_lt_cmd.stdout | lower | trim) != 'none')
      }}

# 17# Obtener versión del agente (rpm -q)
- name: 17# Obtener versión del agente (rpm -q)
  ansible.builtin.command: "rpm -q --qf '%{VERSION}-%{RELEASE}\n' NessusAgent"
  register: _rpm_ver
  changed_when: false
  failed_when: false
  when: ansible_os_family in ['RedHat','OracleLinux','Fedora']

# 18# Obtener versión del agente (--version)
- name: 18# Obtener versión del agente (--version)
  ansible.builtin.command: "{{ nessus_cli_path }} --version"
  register: _cli_ver
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 19# Normalizar versión final
- name: 19# Normalizar versión final
  ansible.builtin.set_fact:
    _agent_version_final: >-
      {{
        (_rpm_ver.stdout | default('') | trim)
        if (ansible_os_family in ['RedHat','OracleLinux','Fedora']
            and (_rpm_ver.stdout | default('') | trim | length > 0))
        else (
          (
            (_cli_ver.stdout | default('') | regex_findall('([0-9]+(?:\\.[0-9]+)+)') | default([]))
            | first | default('')
          )
        )
      }}

# =========================================================
#  FASE 2 - CONSTRUIR RESULTADO Y GENERAR REPORTE
# =========================================================

# 20# Construir resultado por host (incluyendo IP inventario y flags)
- name: 20# Construir resultado por host
  ansible.builtin.set_fact:
    nessus_result:
      host: "{{ inventory_hostname }}"
      ip_address: >-
        {{
          hostvars[inventory_hostname].ansible_host
            | default(inventory_hostname)
        }}
      os_name: "{{ ansible_distribution }}"
      os_family: "{{ ansible_os_family }}"
      os_version: "{{ ansible_distribution_version | default('') }}"
      agent_version: "{{ _agent_version_final | default('') }}"
      installed: "{{ _nessuscli_stat.stat.exists | default(false) }}"
      service_active: >-
        {{
          (_svc_active_final.stdout | default('') | trim) == 'active'
          if (_svc_active_final is defined)
          else false
        }}
      linked: "{{ _linked_bool | bool }}"
      link_status: "{{ _link_status_final }}"
      linked_to: "{{ (_lt_cmd.stdout | default('') | trim) }}"
      restarted_during_audit: "{{ _restarted_during_audit | default(false) }}"
      linked_during_audit: "{{ _linked_during_audit | default(false) }}"
      manager_host: "{{ nessus_manager_host | default('') }}"
      manager_port: "{{ nessus_manager_port | default('') }}"
      groups: "{{ nessus_agent_groups | default('') }}"
      link_output: "{{ (_link_result.stdout | default('') | trim) if (_link_result is defined) else '' }}"
      error: "{{ (_link_result.stderr | default('') | trim) if (_link_result is defined) else '' }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"

# 21# Agregar resultados a lista global (run_once en controlador)
- name: 21# Agregar resultados a lista global
  ansible.builtin.set_fact:
    _nessus_all: "{{ (_nessus_all | default([])) + [hostvars[item].nessus_result] }}"
  loop: "{{ ansible_play_hosts }}"
  run_once: true

# 22# Crear directorio de salida en el controlador
- name: 22# Crear directorio de salida en el controlador
  ansible.builtin.file:
    path: "{{ nessus_output_dir }}"
    state: directory
    mode: "0755"
  run_once: true
  delegate_to: localhost

# 23# Guardar JSON consolidado en el controlador
- name: 23# Guardar JSON consolidado
  ansible.builtin.copy:
    content: "{{ _nessus_all | to_nice_json }}"
    dest: "{{ nessus_output_dir }}/nessus_auditoria_results.json"
    mode: "0644"
  run_once: true
  delegate_to: localhost

# 24# Generar Excel de auditoría en el controlador
- name: 24# Generar Excel de auditoría (controlador)
  ansible.builtin.command: >
    python3 scripts/nessus_excel_report.py
    {{ nessus_output_dir }}/nessus_auditoria_results.json
    {{ nessus_output_dir }}/nessus_auditoria_reporte.xlsx
  register: myoutput
  changed_when: false
  failed_when: myoutput.rc != 0
  run_once: true
  delegate_to: localhost
