---
# 01# Obtener service_facts
- name: 01# Obtener service_facts
  ansible.builtin.service_facts:

# 02# Calcular unit de Nessus (si existe)
- name: 02# Calcular unit de Nessus (si existe)
  ansible.builtin.set_fact:
    nessus_unit: >-
      {{
        'nessusagent' if 'nessusagent.service' in ansible_facts.services
        else (
          'nessus-agent' if 'nessus-agent.service' in ansible_facts.services
          else ''
        )
      }}

# 03# Comprobar existencia de nessuscli
- name: 03# Comprobar existencia de nessuscli
  ansible.builtin.stat:
    path: "{{ nessus_cli_path }}"
  register: _nessuscli_stat

# 04# Consultar systemctl is-active (si hay unit)
- name: 04# Consultar systemctl is-active (si hay unit)
  ansible.builtin.command: "systemctl is-active {{ nessus_unit }}"
  register: _svc_active
  changed_when: false
  failed_when: false
  when: nessus_unit | length > 0

# 05# Ejecutar nessuscli agent status (crudo)
- name: 05# Ejecutar nessuscli agent status (crudo)
  ansible.builtin.shell: "{{ nessus_cli_path }} agent status 2>&1"
  args:
    executable: /bin/bash
  register: _status_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)
  environment:
    LC_ALL: C

# 06# Extraer Link status
- name: 06# Extraer Link status
  ansible.builtin.shell: |
    set -o pipefail
    {{ nessus_cli_path }} agent status 2>&1 \
    | tr -d '\r' \
    | grep -i '^Link[[:space:]]\+status[[:space:]]*:' -m1 \
    | sed -E 's/^[Ll]ink[[:space:]]+status[[:space:]]*:[[:space:]]*//'
  args:
    executable: /bin/bash
  register: _ls_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 07# Extraer Linked to
- name: 07# Extraer Linked to
  ansible.builtin.shell: |
    set -o pipefail
    {{ nessus_cli_path }} agent status 2>&1 \
    | tr -d '\r' \
    | grep -i '^Linked[[:space:]]\+to[[:space:]]*:' -m1 \
    | sed -E 's/^[Ll]inked[[:space:]]+to[[:space:]]*:[[:space:]]*//'
  args:
    executable: /bin/bash
  register: _lt_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 08# Normalizar indicadores de link
- name: 08# Normalizar indicadores de link
  ansible.builtin.set_fact:
    _link_status_final: "{{ (_ls_cmd.stdout | default('') | trim) | default('N/A') }}"
    _linked_bool: >-
      {{
        (_lt_cmd.stdout | default('') | trim | length > 0)
        and ((_lt_cmd.stdout | lower | trim) != 'none')
      }}

# 09# Obtener versión del agente (rpm -q)
- name: 09# Obtener versión del agente (rpm -q)
  ansible.builtin.command: "rpm -q --qf '%{VERSION}-%{RELEASE}\n' NessusAgent"
  register: _rpm_ver
  changed_when: false
  failed_when: false
  when: ansible_os_family in ['RedHat','OracleLinux','Fedora']

# 10# Obtener versión del agente (--version)
- name: 10# Obtener versión del agente (--version)
  ansible.builtin.command: "{{ nessus_cli_path }} --version"
  register: _cli_ver
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 11# Normalizar versión final
- name: 11# Normalizar versión final
  ansible.builtin.set_fact:
    _agent_version_final: >-
      {{
        (_rpm_ver.stdout | default('') | trim)
        if (ansible_os_family in ['RedHat','OracleLinux','Fedora']
            and (_rpm_ver.stdout | default('') | trim | length > 0))
        else (
          (
            (_cli_ver.stdout | default('') | regex_findall('([0-9]+(?:\\.[0-9]+)+)') | default([]))
            | first | default('')
          )
        )
      }}

# 12# Construir resultado por host
- name: 12# Construir resultado por host
  ansible.builtin.set_fact:
    nessus_result:
      host: "{{ inventory_hostname }}"
      ip_address: >-
        {{
          hostvars[inventory_hostname].ansible_host
            | default(inventory_hostname)
        }}
      os_name: "{{ ansible_distribution }}"
      os_family: "{{ ansible_os_family }}"
      os_version: "{{ ansible_distribution_version | default('') }}"
      agent_version: "{{ _agent_version_final | default('') }}"
      installed: "{{ _nessuscli_stat.stat.exists | default(false) }}"
      service_active: "{{ (_svc_active.stdout | default('') | trim) == 'active' }}"
      linked: "{{ _linked_bool | bool }}"
      link_status: "{{ _link_status_final }}"
      linked_to: "{{ (_lt_cmd.stdout | default('') | trim) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"

# 13# Agregar resultados a lista global (run_once)
- name: 13# Agregar resultados a lista global
  ansible.builtin.set_fact:
    _nessus_all: "{{ (_nessus_all | default([])) + [hostvars[item].nessus_result] }}"
  loop: "{{ ansible_play_hosts }}"
  run_once: true

# 14# Crear directorio de salida en el controlador
- name: 14# Crear directorio de salida en el controlador
  ansible.builtin.file:
    path: "{{ nessus_output_dir }}"
    state: directory
    mode: "0755"
  run_once: true
  delegate_to: localhost

# 15# Guardar JSON consolidado
- name: 15# Guardar JSON consolidado
  ansible.builtin.copy:
    content: "{{ _nessus_all | to_nice_json }}"
    dest: "{{ nessus_output_dir }}/nessus_auditoria_results.json"
    mode: "0644"
  run_once: true
  delegate_to: localhost


# 16# Generar Excel (controlador)
- name: 16# Generar Excel de auditoría (controlador)
  ansible.builtin.command: >
    python3 scripts/nessus_excel_report.py
    {{ nessus_output_dir }}/nessus_auditoria_results.json
    {{ nessus_output_dir }}/nessus_auditoria_reporte.xlsx
  register: myoutput
  changed_when: false
  failed_when: myoutput.rc != 0
  run_once: true
  delegate_to: localhost
