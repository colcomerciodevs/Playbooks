---
# =========================================================
#  ROL: nessus_audit
#  Objetivo:
#   1) Detectar unit y existencia de nessuscli
#   2) (Opcional) reiniciar servicio
#   3) Validar si está linkeado
#   4) (Opcional) linkear si no lo está
#   5) Revalidar servicio/estado/link
#   6) Obtener versión
#   7) Consolidar resultados y generar reporte
# =========================================================


# =========================================================
#  FASE 0 - DETECCIÓN BÁSICA + ACCIONES (RESTART -> LINK)
# =========================================================

# 00# Normalizar ruta de nessuscli (fallback universal)
- name: 00# Normalizar nessus_cli_path
  ansible.builtin.set_fact:
    nessus_cli_path: "{{ nessus_cli_path | default('/opt/nessus_agent/sbin/nessuscli') }}"

# 01# Obtener service_facts iniciales (para detectar unit)
- name: 01# Obtener service_facts iniciales
  ansible.builtin.service_facts:

# 02# Calcular unit Nessus si existe (nessusagent vs nessus-agent)
- name: 02# Calcular unit de Nessus (si existe)
  ansible.builtin.set_fact:
    nessus_unit: >-
      {{
        'nessusagent' if 'nessusagent.service' in ansible_facts.services
        else (
          'nessus-agent' if 'nessus-agent.service' in ansible_facts.services
          else ''
        )
      }}

# 03# Comprobar existencia de nessuscli
- name: 03# Comprobar existencia de nessuscli
  ansible.builtin.stat:
    path: "{{ nessus_cli_path }}"
  register: _nessuscli_stat

# DEBUG opcional
- name: DEBUG - Condiciones para reinicio
  ansible.builtin.debug:
    msg:
      nessus_unit: "{{ nessus_unit }}"
      restart_var: "{{ nessus_audit_restart_service | default(false) }}"
      restart_var_bool: "{{ (nessus_audit_restart_service | default(false)) | bool }}"
  when: ansible_verbosity | default(0) | int >= 1

# 04# Reiniciar Nessus Agent (opcional, PRIMERO)
# - Solo si hay unit y flag habilitado.
- name: 04# Reiniciar Nessus Agent (opcional)
  ansible.builtin.systemd:
    name: "{{ nessus_unit }}"
    state: restarted
  when:
    - nessus_unit is defined
    - nessus_unit | trim != ''
    - (nessus_audit_restart_service | default(false)) | bool
  register: _restart_res
  failed_when: false

# 05# Flag de reinicio durante auditoría
- name: 05# Marcar flag de reinicio durante auditoría
  ansible.builtin.set_fact:
    _restarted_during_audit: >-
      {{
        _restart_res is defined
        and (_restart_res is not skipped)
      }}
  when: nessus_unit | trim != ''

# 06# Ejecutar status tras reinicio
- name: 06# Ejecutar nessuscli agent status (post-reinicio)
  ansible.builtin.shell: "{{ nessus_cli_path }} agent status 2>&1"
  args:
    executable: /bin/bash
  register: _status_post_restart
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)
  environment:
    LC_ALL: C

# 07# Evaluar si NO está linkeado (busca "Linked to: None")
- name: 07# Evaluar si el agente no está linkeado (post-reinicio)
  ansible.builtin.set_fact:
    _pre_not_linked: >-
      {{
        _status_post_restart.stdout is defined
        and (_status_post_restart.stdout | default('')) is search('Linked to:\\s*None')
      }}
  when: _status_post_restart is defined

# 08# Linkear si no está linkeado (OPCIONAL)
- name: 08# Linkear Nessus Agent (si no está linkeado)
  ansible.builtin.command: >
    {{ nessus_cli_path }} agent link
    --key={{ nessus_agent_key }}
    --host={{ nessus_manager_host }}
    --port={{ nessus_manager_port }}
  register: _link_result
  when:
    - (nessus_audit_try_link | default(false)) | bool
    - _nessuscli_stat.stat.exists | default(false)
    - _pre_not_linked | default(false)
    - nessus_agent_key | default('') | length > 0
    - nessus_manager_host | default('') | length > 0
  failed_when: false
  changed_when: >
    'Successfully linked' in (_link_result.stdout | default('')) or
    'already linked' in (_link_result.stdout | default(''))

# 09# Flag de link durante auditoría
- name: 09# Marcar flag de link durante auditoría
  ansible.builtin.set_fact:
    _linked_during_audit: >-
      {{
        _link_result is defined
        and (
          'Successfully linked' in (_link_result.stdout | default(''))
          or 'already linked' in (_link_result.stdout | default(''))
        )
      }}
  when: _link_result is defined


# =========================================================
#  FASE 1 - RE-OBTENER ESTADO REAL DESPUÉS DE ACCIONES
# =========================================================

# 10# Refrescar services post-acciones
- name: 10# Refrescar service_facts (post-acciones)
  ansible.builtin.service_facts:

# 11# Recalcular unit post-acciones
- name: 11# Recalcular unit de Nessus (post-acciones)
  ansible.builtin.set_fact:
    nessus_unit: >-
      {{
        'nessusagent' if 'nessusagent.service' in ansible_facts.services
        else (
          'nessus-agent' if 'nessus-agent.service' in ansible_facts.services
          else ''
        )
      }}

# 12# systemctl is-active final
- name: 12# Consultar systemctl is-active (estado final)
  ansible.builtin.command: "systemctl is-active {{ nessus_unit }}"
  register: _svc_active_final
  changed_when: false
  failed_when: false
  when: nessus_unit | length > 0

# 13# status final del agente
- name: 13# Ejecutar nessuscli agent status (estado final)
  ansible.builtin.shell: "{{ nessus_cli_path }} agent status 2>&1"
  args:
    executable: /bin/bash
  register: _status_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)
  environment:
    LC_ALL: C

# 14# Extraer Link status final
- name: 14# Extraer Link status (estado final)
  ansible.builtin.shell: |
    set -o pipefail
    {{ nessus_cli_path }} agent status 2>&1 \
    | tr -d '\r' \
    | grep -i '^Link[[:space:]]\+status[[:space:]]*:' -m1 \
    | sed -E 's/^[Ll]ink[[:space:]]+status[[:space:]]*:[[:space:]]*//'
  args:
    executable: /bin/bash
  register: _ls_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 15# Extraer Linked to final
- name: 15# Extraer Linked to (estado final)
  ansible.builtin.shell: |
    set -o pipefail
    {{ nessus_cli_path }} agent status 2>&1 \
    | tr -d '\r' \
    | grep -i '^Linked[[:space:]]\+to[[:space:]]*:' -m1 \
    | sed -E 's/^[Ll]inked[[:space:]]+to[[:space:]]*:[[:space:]]*//'
  args:
    executable: /bin/bash
  register: _lt_cmd
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 16# Normalizar flags finales de link
- name: 16# Normalizar indicadores finales de link
  ansible.builtin.set_fact:
    _link_status_final: "{{ (_ls_cmd.stdout | default('') | trim) | default('N/A') }}"
    _linked_bool: >-
      {{
        (_lt_cmd.stdout | default('') | trim | length > 0)
        and ((_lt_cmd.stdout | lower | trim) != 'none')
      }}

# 17# Obtener versión por rpm si NO es apt (RHEL/OL/Fedora/SUSE/Amazon)
# - Esto evita error en Debian/Ubuntu.
- name: 17# Obtener versión del agente (rpm -q)
  ansible.builtin.command: "rpm -q --qf '%{VERSION}-%{RELEASE}\n' NessusAgent"
  register: _rpm_ver
  changed_when: false
  failed_when: false
  when:
    - _nessuscli_stat.stat.exists | default(false)
    - ansible_facts.pkg_mgr != 'apt'

# 18# Obtener versión por cli (universal)
- name: 18# Obtener versión del agente (--version)
  ansible.builtin.command: "{{ nessus_cli_path }} --version"
  register: _cli_ver
  changed_when: false
  failed_when: false
  when: _nessuscli_stat.stat.exists | default(false)

# 19# Normalizar versión final (prioriza rpm si existe)
- name: 19# Normalizar versión final
  ansible.builtin.set_fact:
    _agent_version_final: >-
      {{
        (_rpm_ver.stdout | default('') | trim)
        if ((_rpm_ver.stdout | default('') | trim | length) > 0)
        else (
          (
            (_cli_ver.stdout | default('') | regex_findall('([0-9]+(?:\\.[0-9]+)+)') | default([]))
            | first | default('')
          )
        )
      }}


# =========================================================
#  FASE 2 - CONSTRUIR RESULTADO + CONSOLIDAR + REPORTE
# =========================================================

# 20# Resultado final por host
- name: 20# Construir resultado por host
  ansible.builtin.set_fact:
    nessus_result:
      host: "{{ inventory_hostname }}"
      hostname: "{{ ansible_hostname }}"
      ip_address: "{{ hostvars[inventory_hostname].ansible_host | default(inventory_hostname) }}"
      os_name: "{{ ansible_distribution }}"
      os_family: "{{ ansible_os_family }}"
      os_version: "{{ ansible_distribution_version | default('') }}"
      agent_version: "{{ _agent_version_final | default('') }}"
      installed: "{{ _nessuscli_stat.stat.exists | default(false) }}"
      service_active: >-
        {{
          (_svc_active_final.stdout | default('') | trim) == 'active'
          if (_svc_active_final is defined)
          else false
        }}
      linked: "{{ _linked_bool | bool }}"
      link_status: "{{ _link_status_final }}"
      linked_to: "{{ (_lt_cmd.stdout | default('') | trim) }}"
      restarted_during_audit: "{{ _restarted_during_audit | default(false) }}"
      linked_during_audit: "{{ _linked_during_audit | default(false) }}"
      manager_host: "{{ nessus_manager_host | default('') }}"
      manager_port: "{{ nessus_manager_port | default('') }}"
      groups: "{{ nessus_agent_groups | default('') }}"
      link_output: "{{ (_link_result.stdout | default('') | trim) if (_link_result is defined) else '' }}"
      error: "{{ (_link_result.stderr | default('') | trim) if (_link_result is defined) else '' }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"

# 21# Consolidar lista global una sola vez en el controlador
- name: 21# Agregar resultados a lista global
  ansible.builtin.set_fact:
    _nessus_all: "{{ (_nessus_all | default([])) + [hostvars[item].nessus_result] }}"
  loop: "{{ ansible_play_hosts }}"
  run_once: true

# 22# Crear directorio de salida en controlador
- name: 22# Crear directorio de salida en el controlador
  ansible.builtin.file:
    path: "{{ nessus_output_dir }}"
    state: directory
    mode: "0755"
  run_once: true
  delegate_to: localhost

# 23# Guardar JSON consolidado
- name: 23# Guardar JSON consolidado
  ansible.builtin.copy:
    content: "{{ _nessus_all | to_nice_json }}"
    dest: "{{ nessus_output_dir }}/nessus_auditoria_results.json"
    mode: "0644"
  run_once: true
  delegate_to: localhost

# 24# Generar Excel con tu script
- name: 24# Generar Excel de auditoría (controlador)
  ansible.builtin.command: >
    python3 scripts/nessus_excel_report.py
    {{ nessus_output_dir }}/nessus_auditoria_results.json
    {{ nessus_output_dir }}/nessus_auditoria_reporte.xlsx
  register: myoutput
  changed_when: false
  failed_when: myoutput.rc != 0
  run_once: true
  delegate_to: localhost
